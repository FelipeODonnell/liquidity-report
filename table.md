# Price Comparison Table: Spot vs Futures Markets

## Overview
The Price Comparison table in the Report page displays spot and futures price data for BTC, ETH, SOL, and XRP with percentage changes over 24h, 7d, and 30d periods.

## Data Sources

### Spot Price Data
- **Files**: `data/[DATE]/spot/spot_market/api_spot_price_history_[ASSET].parquet`
- **Columns**: `time`, `open`, `high`, `low`, `close`, `volume_usd`
- **Granularity**: Daily (1 data point per day)
- **Processing**: 
  - Timestamps are converted from milliseconds to datetime
  - Data is sorted by datetime
  - Latest close price is used as current spot price

### Futures Price Data
- **Current Price**: `data/[DATE]/futures/market/api_futures_pairs_markets_[ASSET].parquet`
  - Uses average of `current_price` across all exchanges
  - 24h change uses average of `price_change_percent_24h` column
- **Historical Data**: `data/[DATE]/futures/market/api_price_ohlc_history.parquet`
  - Used for 7d and 30d change calculations
  - Contains OHLC data for longer-term comparisons

## How Percentage Changes Are Calculated

### Spot Changes
```python
# For each period (24h, 7d, 30d):
cutoff_date = current_date - timedelta(days=period)
filtered_data = data[data['datetime'] >= cutoff_date]
first_price = filtered_data['close'].iloc[0]
last_price = filtered_data['close'].iloc[-1]
change_percent = (last_price - first_price) / first_price * 100
```

### Futures Changes
- **24h Change**: Directly taken from `price_change_percent_24h` column (averaged across exchanges)
- **7d/30d Changes**: Calculated using the same method as spot changes from OHLC history data

## Issues with 24h Spot Change Data

### Problem 1: Data Granularity
The 24h spot change appears to be incorrect or misleading because:

1. **Data Granularity**: The spot price history data only contains **daily data points** (one close price per day at midnight UTC)
2. **Actual Calculation**: When calculating "24h change", the code filters for `datetime >= (now - 24 hours)`
3. **Result**: This typically returns only 2 data points:
   - Yesterday's close (24 hours ago)
   - Today's close (current)
4. **What It Shows**: The "24h change" is actually the change from yesterday's daily close to today's daily close, not a true intraday 24-hour change

### Problem 2: Percentage Formatting Bug (Primary Issue)
**This is why the 24h change values appear too high and incorrect:**

The `format_percentage()` function in `utils/formatters.py` has auto-detection logic that incorrectly multiplies small percentage values by 100:

```python
# Lines 170-172 in format_percentage()
if abs(num) <= 1 and not (abs(num) == 1 and num != 0):
    # Value is likely a decimal (e.g., 0.05), convert to percentage
    num *= 100
```

**What happens:**
1. The spot price change is calculated correctly as a percentage (e.g., 0.58 for 0.58%)
2. When passed to `format_percentage()`, the function sees 0.58 is less than 1
3. It assumes this is a decimal representation (like 0.0058 for 0.58%) and multiplies by 100
4. The displayed value becomes 58% instead of 0.58%

**Example:**
- Actual price change: 0.58%
- Value passed to formatter: 0.58
- Formatter thinks: "This must be 0.0058 (decimal form)"
- Formatter multiplies: 0.58 Ã— 100 = 58
- Displayed result: 58% (100x too high!)

### Why This Is Misleading
- The actual daily price changes for crypto are typically 0.5-3%, not 50-300%
- Users see unrealistic percentage changes that don't match market reality
- The futures data doesn't go through the same formatting issue, creating inconsistency

### Recommended Solutions
1. **Fix the formatting logic** (Immediate fix):
   - The percentage calculation already returns a percentage value (not a decimal)
   - Either:
     - Pass a flag to `format_percentage()` indicating the value is already a percentage
     - Divide the calculated percentage by 100 before passing to the formatter
     - Modify the auto-detection logic to handle this case better

2. **Fix the data granularity** (Long-term fix):
   - Use more granular spot price data (hourly or minute-level)
   - Or rename "24h Change" to "Daily Change" to accurately reflect the data

3. **Ensure consistency**:
   - Make sure both spot and futures percentage changes go through the same formatting process
   - Add unit tests for the percentage formatting function with various input ranges

## Code Location
The table is generated by the `prepare_price_comparison_dataframe()` function in:
- File: `streamlit/pages/01_report.py`
- Lines: 164-275